<div *ngIf="purchaseOrder" class="card shadow-lg w-100 mx-auto">
  <div class="card-header">
    <h4 class="mb-0">
      Purchase Order #{{ purchaseOrder.purchaseOrderNumber.toString().padStart(8, '0') }}
    </h4>
  </div>
<form [formGroup]="form" (ngSubmit)="saveChanges()">
  <div class="card-body">
   
    <div class="row mb-4" >
      <div class="col-md-6">
        <p><strong>Created:</strong> {{ purchaseOrder.creationDate | date }}</p>
        <p><strong>Employee:</strong> {{ purchaseOrder.employeeFullName }}</p>
        <p><strong>Department:</strong> {{ purchaseOrder.departmentName }}</p>
        <p><strong>Supervisor:</strong> {{ purchaseOrder.supervisorFullName }}</p>
      </div>
      <div class="col-md-6">
         <p><strong>Status:</strong> {{ purchaseOrder.purchaseStatus }}</p>
      <p><strong>Subtotal:</strong> {{ subtotal | currency }}</p>
      <p><strong>Tax:</strong> {{ taxTotal | currency }}</p>
      <p><strong>Total:</strong> {{ grandTotal | currency }}</p>
      </div>
    </div>

    <!-- Items Table -->
    <h5 class="fw-bold mt-4">Items</h5>
    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
      <table class="table table-bordered table-hover">
        <thead class="thead-light" style="position: sticky; top: 0; background: white;">
          <tr>
            <th>Name</th>
            <th>Description</th>
            <th>Qty</th>
            <th>Price</th>
            <th>Justification</th>
            <th>Location</th>
            <th>Status</th>
            <th>Subtotal</th>
            <th>Tax Total</th>
            <th>Grand Total</th>
             <th *ngIf="isEditable()">Actions</th>
          </tr>
        </thead>
       <tbody formArrayName="items">
        <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i">
          <td>
            <input class="form-control" formControlName="itemName" 
                   [readonly]="!canEditItem(item) || editRowIndex !== i" />
            <div *ngIf="item.get('itemName')?.touched && item.get('itemName')?.invalid" class="text-danger small">
              <div *ngIf="item.get('itemName')?.errors?.['required']">Required</div>
              <div *ngIf="item.get('itemName')?.errors?.['minlength']">min length is 3</div>
              <div *ngIf="item.get('itemName')?.errors?.['maxlength']">Max length is 45</div>
            </div>
          </td>
          <td>
            <input class="form-control" formControlName="itemDescription" 
                   [readonly]="!canEditItem(item) || editRowIndex !== i" />
                    <div *ngIf="item.get('itemDescription')?.touched && item.get('itemDescription')?.invalid" class="text-danger small">
              <div *ngIf="item.get('itemDescription')?.errors?.['required']">Required</div>
              <div *ngIf="item.get('itemDescription')?.errors?.['minlength']">Min length is 5</div>
              
            </div>
          </td>
          <td>
            <input type="number" class="form-control" formControlName="itemQuantity" 
                   [readonly]="!canEditItem(item) || editRowIndex !== i" />
                    <div *ngIf="item.get('itemQuantity')?.touched && item.get('itemQuantity')?.invalid" class="text-danger small">
              <div *ngIf="item.get('itemQuantity')?.errors?.['required']">Quantity is required</div>
               <div *ngIf="item.get('itemQuantity')?.errors?.['min']">Must be greater than zero</div>

              
            </div>
          </td>
          <td>
  
              <span *ngIf="!canEditItem(item) || editRowIndex !== i">
                {{ item.get('itemPrice')?.value | currency }}
              </span>

              <input
                *ngIf="canEditItem(item) && editRowIndex === i"
                type="number"
                class="form-control"
                formControlName="itemPrice"
              />

           
              <div *ngIf="editRowIndex === i && item.get('itemPrice')?.touched && item.get('itemPrice')?.invalid" class="text-danger small">
                <div *ngIf="item.get('itemPrice')?.errors?.['required']">Price is required</div>
                <div *ngIf="item.get('itemPrice')?.errors?.['min']">Must be greater than zero</div>
              </div>
            </td>

          <!-- <td>
            <input type="number" class="form-control" formControlName="itemPrice" 
                   [readonly]="!canEditItem(item) || editRowIndex !== i" />
                    <div *ngIf="item.get('itemPrice')?.touched && item.get('itemPrice')?.invalid" class="text-danger small">
              <div *ngIf="item.get('itemPrice')?.errors?.['required']">Price is required</div>
              <div *ngIf="item.get('itemPrice')?.errors?.['min']">Must be greater than zero</div>
              
            </div>
          </td> -->
          <td>
            <input class="form-control" formControlName="itemJustification" 
                   [readonly]="!canEditItem(item) || editRowIndex !== i" />
                    <div *ngIf="item.get('itemJustification')?.touched && item.get('itemJustification')?.invalid" class="text-danger small">
              <div *ngIf="item.get('itemJustification')?.errors?.['required']">Required</div>
              <div *ngIf="item.get('itemJustification')?.errors?.['minlength']">Min length is 4</div>
             
            </div>
          </td>
          <td>
            <input class="form-control" formControlName="itemPurchaseLocation" 
                   [readonly]="!canEditItem(item) || editRowIndex !== i" />
                    <div *ngIf="item.get('itemPurchaseLocation')?.touched && item.get('itemPurchaseLocation')?.invalid" class="text-danger small">
              <div *ngIf="item.get('itemPurchaseLocation')?.errors?.['required']">Required</div>
              <div *ngIf="item.get('itemPurchaseLocation')?.errors?.['minlength']">Min length is 5</div>
             
            </div>
          </td>
           <td>{{ isPurchaseOrderClosed ? item.get('itemStatus')?.value :item.get('itemDescription')?.value === 'No longer needed'
        ? 'Denied': 'Pending'  }}</td>
          <!-- <td>{{ isPurchaseOrderClosed ? item.get('itemStatus')?.value : 'Pending'  }}</td> -->
          <td>{{ item.get('itemPrice')?.value * item.get('itemQuantity')?.value | currency }}</td>
          <td>{{ item.get('itemPrice')?.value * item.get('itemQuantity')?.value * 0.15 | currency }}</td>
          <td>{{ item.get('itemPrice')?.value * item.get('itemQuantity')?.value * 1.15 | currency }}</td>
          <td *ngIf="isEditable() && canEditItem(item)">
            <button *ngIf="item.get('id')?.value === 0 && editRowIndex === i"  class="btn btn-sm btn-outline-danger me-1" type="button" (click)="removeItem(i)">Remove</button>
            <button class="btn btn-sm btn-outline-warning me-1" type="button" (click)="markItemAsNotRequired(i)">No Longer Needed</button>

            <!-- Edit or Save -->
            <button 
              *ngIf="editRowIndex !== i" 
              class="btn btn-sm btn-outline-secondary" 
              type="button" 
              (click)="editRowIndex = i">
              Edit
            </button>

            <button 
              *ngIf="editRowIndex === i" 
              class="btn btn-sm btn-success" 
              type="button" 
              (click)="saveNewItem(i)">
              Save
            </button>
          </td>
        </tr>
      </tbody>
      </table>
    </div>
<div class="text-end mt-3" *ngIf="isEditable()">
    <button type="button" class="btn btn-outline-primary me-2" (click)="addEmptyItemRow()">Add Item</button>
    <button type="submit" class="btn btn-success">Save Changes</button>
  </div>

  </div>

</form>
<!-- Error Message -->
<div *ngIf="error" class="alert alert-danger mt-3 w-100 text-center">
  {{ error }}
</div>

<!-- Navigation Buttons -->
<div class="card shadow-card my-2">
  <div class="card-body d-flex gap-2 justify-content-end">
    <div class="d-flex gap-2">
      <button class="btn btn-primary" (click)="goTo('previous')" [disabled]="!canNavigate('previous')">Previous</button>
      <button class="btn btn-primary" (click)="goTo('next')" [disabled]="!canNavigate('next')">Next</button>
    </div>
    <a class="btn btn-outline-primary" [routerLink]="['/po/search']">Back To Search Purchase Order</a>
  </div>
</div>
